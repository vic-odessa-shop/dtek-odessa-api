<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú–æ–π –°–≤–µ—Ç (–û–¥–µ—Å—Å–∞)</title>
    <style>
        body { font-family: sans-serif; background: #f4f7f9; padding: 15px; }
        .card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-bottom: 15px; }
        input { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 10px; }
        .btn-add { width: 100%; padding: 12px; background: #007bff; color: white; border: none; border-radius: 10px; font-weight: bold; }
        .btn-check { width: 100%; padding: 15px; background: #28a745; color: white; border: none; border-radius: 10px; font-weight: bold; font-size: 1.1em; cursor: pointer; text-decoration: none; display: block; text-align: center; }
        .addr-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .delete-btn { color: #ff4d4d; border: none; background: none; cursor: pointer; }
        .hint { font-size: 0.8em; color: #666; margin-bottom: 10px; }
    </style>
</head>
<body>

    <div class="card">
        <h3>–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π –∞–¥—Ä–µ—Å</h3>
        <p class="hint">–í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –æ–¥–∏–Ω —Ä–∞–∑, –∏ –æ–Ω–∏ —Å–æ—Ö—Ä–∞–Ω—è—Ç—Å—è.</p>
        <input type="text" id="street" placeholder="–£–ª–∏—Ü–∞ (–õ—é—Å—Ç–¥–æ—Ä—Ñ—Å—å–∫–∞)">
        <input type="text" id="house" placeholder="–ù–æ–º–µ—Ä –¥–æ–º–∞ (189)">
        <button class="btn-add" onclick="addNewAddress()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∞–¥—Ä–µ—Å</button>
    </div>

    <div id="list"></div>

    <script>
                let addresses = JSON.parse(localStorage.getItem('dtek_list')) || [];

        function saveAndRender() {
            localStorage.setItem('dtek_list', JSON.stringify(addresses));
            render();
        }

        function add() {
            const street = document.getElementById('street').value;
            const house = document.getElementById('house').value;
            if(street && house) {
                addresses.push({ street, house });
                saveAndRender();
            }
        }

        function remove(index) {
            addresses.splice(index, 1);
            saveAndRender();
        }

        // –°–ê–ú–ê–Ø –í–ê–ñ–ù–ê–Ø –ß–ê–°–¢–¨: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫ –±–µ–∑ –≤–≤–æ–¥–∞ —Ä—É—á–∫–∞–º–∏
        async function checkStatus(index, street, house) {
            const container = document.getElementById(`status-${index}`);
            container.innerHTML = "‚åõ –ò—â—É —Ç–≤–æ–π –∞–¥—Ä–µ—Å –≤ –±–∞–∑–µ –î–¢–≠–ö...";
            
            try {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –ø—Ä–æ–∫—Å–∏, —á—Ç–æ–±—ã –±—Ä–∞—É–∑–µ—Ä –Ω–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞–ª –∑–∞–ø—Ä–æ—Å
                const proxy = "https://api.allorigins.win/get?url=";
                
                // 1. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—â–µ–º ID —É–ª–∏—Ü—ã
                const streetUrl = encodeURIComponent(`https://www.dtek-oem.com.ua/ua/ajax/get-streets?city=–û–¥–µ—Å–∞&query=${street}`);
                const streetRes = await fetch(proxy + streetUrl);
                const streetData = await streetRes.json();
                const streets = JSON.parse(streetData.contents);

                if (!streets || !streets[0]) throw new Error("–£–ª–∏—Ü–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞");
                const streetId = streets[0].id;

                // 2. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—â–µ–º ID –¥–æ–º–∞
                const houseUrl = encodeURIComponent(`https://www.dtek-oem.com.ua/ua/ajax/get-houses?street=${streetId}&query=${house}`);
                const houseRes = await fetch(proxy + houseUrl);
                const houseData = await houseRes.json();
                const houses = JSON.parse(houseData.contents);

                if (!houses || !houses[0]) throw new Error("–î–æ–º –Ω–µ –Ω–∞–π–¥–µ–Ω");
                const houseId = houses[0].id;

                // 3. –¢–µ–ø–µ—Ä—å —É –Ω–∞—Å –µ—Å—Ç—å ID, –æ—Ç–∫—Ä—ã–≤–∞–µ–º –≥—Ä–∞—Ñ–∏–∫ –æ–¥–Ω–æ–π –∫–Ω–æ–ø–∫–æ–π
                container.innerHTML = `
                    <div style="background:#e7f3ff; padding:10px; border-radius:10px; border:1px solid #b3d7ff;">
                        <p style="margin:0 0 10px 0; font-weight:bold; color:#0056b3;">–ê–¥—Ä–µ—Å –Ω–∞–π–¥–µ–Ω!</p>
                        <a href="https://www.dtek-oem.com.ua/ua/shutdowns?query=${street} ${house}" target="_blank" 
                           style="display:block; padding:12px; background:#28a745; color:white; text-decoration:none; border-radius:8px; text-align:center; font-weight:bold;">
                           –û–¢–ö–†–´–¢–¨ –ì–†–ê–§–ò–ö
                        </a>
                    </div>
                `;
            } catch (e) {
                // –ï—Å–ª–∏ –ø—Ä–æ–∫—Å–∏ —Ç—É–ø–∏—Ç, –¥–∞–µ–º –∑–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç
                container.innerHTML = `
                    <a href="https://www.dtek-oem.com.ua/ua/shutdowns?query=${street} ${house}" target="_blank" 
                       style="display:block; padding:12px; background:#ffc107; color:black; text-decoration:none; border-radius:8px; text-align:center; font-weight:bold;">
                       –ü–ï–†–ï–ô–¢–ò –ö –ü–û–ò–°–ö–£
                    </a>
                    <p style="font-size:0.7em; color:gray; margin-top:5px;">–î–¢–≠–ö –∑–∞—â–∏—â–µ–Ω, –Ω–æ –∞–¥—Ä–µ—Å —É–∂–µ –ø–æ–¥—Å—Ç–∞–≤–ª–µ–Ω –≤ –ø–æ–∏—Å–∫–µ!</p>
                `;
            }
        }

        function render() {
            const listDiv = document.getElementById('list');
            listDiv.innerHTML = addresses.map((addr, i) => `
                <div class="card">
                    <div class="addr-title">
                        <strong>üìç ${addr.street}, ${addr.house}</strong>
                        <span class="delete" onclick="remove(${i})">–£–¥–∞–ª–∏—Ç—å</span>
                    </div>
                    <div class="status-box" id="status-${i}">
                        <button style="background:#007bff; margin-top:10px;" onclick="checkStatus(${i}, '${addr.street}', '${addr.house}')">
                            –ü–†–û–í–ï–†–ò–¢–¨
                        </button>
                    </div>
                </div>
            `).join('');
        }

        render();

    </script>
</body>
</html>
